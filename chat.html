<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Interface</title>
    <style>
        :root {
            --bg-color: #f5f7fa;
            --container-bg: rgba(255, 255, 255, 0.85);
            --sidebar-bg: rgba(248, 249, 251, 0.8);
            --border-color: rgba(0, 0, 0, 0.07);
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --blue-accent: #007aff;
            --blue-accent-hover: #0051d5;
            --user-bubble: #007aff;
            --assistant-bubble: #f2f2f7;
            --input-bg: #f2f2f7;
            --input-bg-focus: #e8e8ed;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ebf0 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
            color: var(--text-primary);
        }

        /* --- Main Layout --- */
        .app-layout {
            width: 100%;
            max-width: 1200px;
            height: 95vh;
            max-height: 900px;
            display: flex;
            background: var(--container-bg);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1), 0 0 1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 260px;
            flex-shrink: 0;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
        }

        .sidebar-header {
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-header h2 {
            font-size: 17px;
            font-weight: 600;
        }

        .sidebar-header p {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .file-list-container {
            flex: 1;
            overflow-y: auto;
            margin-top: 16px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            animation: fadeInUp 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-item:hover {
            background: rgba(0, 0, 0, 0.04);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }
        
        .file-info svg {
            flex-shrink: 0;
        }
        
        .file-info span {
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .delete-file-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-left: 8px;
        }
        
        .delete-file-btn:hover {
            background: rgba(0, 0, 0, 0.08);
        }
        
        .delete-file-btn svg {
            fill: var(--text-secondary);
        }

        .sidebar-footer {
            margin-top: 16px;
        }

        .sidebar-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 8px;
        }

        #uploadBtn {
            background: var(--blue-accent);
            color: white;
        }
        
        #uploadBtn:hover {
            background: var(--blue-accent-hover);
        }

        .secondary-btn {
            background: var(--assistant-bubble);
            color: var(--blue-accent);
        }
        
        .secondary-btn:hover {
            background: #e5e5ea;
        }

        /* --- Chat Container --- */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        /* Loading overlay for API calls */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(4px);
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 10;
            flex-direction: column;
            gap: 12px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .loading-overlay.visible {
            display: flex;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top-color: var(--blue-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .chat-header {
            padding: 20px 28px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .header-title {
            font-size: 17px;
            font-weight: 600;
        }

        .header-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* --- Chat Messages --- */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chat-messages::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-track { background: transparent; }
        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }
        .chat-messages::-webkit-scrollbar-thumb:hover { background: rgba(0, 0, 0, 0.15); }

        .message {
            display: flex;
            gap: 12px;
            max-width: 85%;
            align-self: flex-start;
        }

        .message.animated {
            animation: fadeInUp 0.3s ease;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
            align-self: flex-end;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .message-body {
            display: flex;
            flex-direction: column;
        }

        .message-content {
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.5;
            word-wrap: break-word;
        }
        
        .message-content pre {
            background: #2d2d2d;
            color: #f1f1f1;
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'SF Mono', 'Menlo', 'Consolas', monospace;
            font-size: 14px;
        }
        
        .message-content code {
            font-family: 'SF Mono', 'Menlo', 'Consolas', monospace;
            background: #e0e0e0;
            padding: 2px 4px;
            border-radius: 4px;
        }
        
        .message-content pre code {
            background: none;
            padding: 0;
        }

        .message.assistant .message-content {
            background: var(--assistant-bubble);
            border-bottom-left-radius: 4px;
        }

        .message.user .message-content {
            background: var(--user-bubble);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .timestamp {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
            padding: 0 4px;
        }
        
        .message.user .timestamp {
            text-align: right;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
            30% { opacity: 1; transform: translateY(-8px); }
        }

        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            margin: auto;
        }

        .welcome-message h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        /* --- Chat Input --- */
        .chat-input-container {
            padding: 16px 24px 20px;
            border-top: 1px solid var(--border-color);
            background: var(--container-bg);
            backdrop-filter: blur(20px);
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            background: var(--input-bg);
            border-radius: 20px;
            padding: 8px 12px 8px 18px;
            transition: all 0.2s ease;
        }

        .input-wrapper:focus-within {
            background: var(--input-bg-focus);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .chat-input {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            font-size: 15px;
            font-family: inherit;
            resize: none;
            max-height: 120px;
            min-height: 24px;
            padding: 6px 0;
        }

        .chat-input::placeholder {
            color: var(--text-secondary);
        }

        .send-button {
            width: 32px;
            height: 32px;
            background: var(--blue-accent);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .send-button:hover {
            background: var(--blue-accent-hover);
            transform: scale(1.05);
        }

        .send-button:active {
            transform: scale(0.95);
        }

        .send-button:disabled {
            background: #c7c7cc;
            cursor: not-allowed;
            transform: scale(1);
        }

        .send-button svg {
            width: 16px;
            height: 16px;
            fill: white;
        }
        
        .input-options {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 12px;
            padding-top: 10px;
        }
        
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
        }
        
        .toggle-switch input {
            display: none;
        }
        
        .slider {
            width: 34px;
            height: 20px;
            background: #ccc;
            border-radius: 10px;
            position: relative;
            transition: background 0.2s ease;
        }
        
        .slider:before {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            left: 2px;
            top: 2px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s ease;
        }
        
        .toggle-switch input:checked + .slider {
            background: var(--blue-accent);
        }
        
        .toggle-switch input:checked + .slider:before {
            transform: translateX(14px);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }
        
            .app-layout {
                height: 100vh;
                max-height: none;
                border-radius: 0;
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 250px; /* Fixed height for mobile sidebar */
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                flex-shrink: 0;
            }
            
            .chat-container {
                height: calc(100% - 250px);
            }
            
            .chat-header {
                padding: 16px;
            }
            
            .chat-messages {
                padding: 16px;
            }
            
            .chat-input-container {
                padding: 12px;
            }
            
            .message {
                max-width: 90%;
            }
        }

    </style>
</head>
<body>
    <div class="app-layout">
        <!-- === Sidebar === -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Local RAG</h2>
                <p>Add files to your local vector DB.</p>
            </div>
            
            <div class="file-list-container" id="fileList">
                <!-- File items will be injected here -->
            </div>
            
            <div class="sidebar-footer">
                <input type="file" id="fileUpload" hidden multiple>
                <label for="fileUpload" class="sidebar-btn" id="uploadBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    Add File
                </label>
                <button class="sidebar-btn secondary-btn" id="clearChatBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    Clear Chat
                </button>
            </div>
        </div>

        <!-- === Chat Container === -->
        <div class="chat-container">
            <!-- Loading Overlay -->
            <div class="loading-overlay" id="loadingOverlay">
                <div class="spinner"></div>
                <div id="loadingText">Processing...</div>
            </div>
        
            <div class="chat-header">
                <div class="avatar">AI</div>
                <div>
                    <div class="header-title">Assistant</div>
                    <div class="header-subtitle">Ready to help</div>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="welcome-message" id="welcomeMessage">
                    <h2>How can I help you?</h2>
                    <p>Ask me anything, or add a file to start.</p>
                </div>
                <!-- Messages will be injected here -->
            </div>

            <div class="chat-input-container">
                <div class="input-wrapper">
                    <textarea class="chat-input" id="chatInput" placeholder="Message..." rows="1"></textarea>
                    <button class="send-button" id="sendButton" disabled>
                        <svg viewBox="0 0 24 24">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>
                <div class="input-options">
                    <label class="toggle-switch">
                        <input type="checkbox" id="searchWebToggle">
                        <span class="slider"></span>
                        <span style="margin-left: 6px;">Search Web</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const fileUpload = document.getElementById('fileUpload');
        const fileList = document.getElementById('fileList');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const searchWebToggle = document.getElementById('searchWebToggle');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');

        // --- localStorage Keys ---
        const CHAT_HISTORY_KEY = 'chatHistory';
        const FILE_LIST_KEY = 'fileList'; // Stores only file names now

        // --- API Configuration ---
        // DO NOT expose this key in a public website.
        // It's okay here because this is a 100% local-only file.
        const GEMINI_API_KEY = "AIzaSyBfNctzrMc1qVC_f2oFp0lYs4kLjWhYZ-c"; // <<< ⚠️ ADD YOUR KEY
        const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
        
        // Backend URL
        const BACKEND_URL = 'http://localhost:5000';

        // --- State ---
        let isSendingMessage = false;

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            if (GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_GOES_HERE") {
                addMessage("Warning: Gemini API key not set. Please add your API key to chat.html to enable AI responses.", "assistant");
            }
            loadHistory();
            loadFiles();
        });

        chatInput.addEventListener('input', () => {
            chatInput.style.height = 'auto';
            chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
            sendButton.disabled = chatInput.value.trim() === '' || isSendingMessage;
        });

        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendButton.addEventListener('click', sendMessage);
        clearChatBtn.addEventListener('click', clearChat);
        fileUpload.addEventListener('change', handleFileUpload);
        fileList.addEventListener('click', handleFileDelete);

        // --- Loading Overlay Functions ---
        function showLoading(text) {
            loadingText.textContent = text;
            loadingOverlay.classList.add('visible');
            isSendingMessage = true;
            sendButton.disabled = true;
        }

        function hideLoading() {
            loadingOverlay.classList.remove('visible');
            isSendingMessage = false;
            sendButton.disabled = chatInput.value.trim() === '';
        }

        // --- Core Chat Functions ---
        async function sendMessage() {
            const messageText = chatInput.value.trim();
            if (!messageText || isSendingMessage) return;

            removeWelcomeMessage();
            addMessage(messageText, 'user');
            saveMessage(messageText, 'user');

            chatInput.value = '';
            chatInput.style.height = 'auto';
            
            showLoading("Thinking...");

            try {
                const history = getHistory().slice(-10); // Get last 10 messages
                const formattedHistory = historyToGeminiFormat(history);
                const useSearch = searchWebToggle.checked;

                // --- New RAG Flow ---
                // 1. Get relevant context from our backend
                let fileContextString = "";
                showLoading("Searching files...");
                try {
                    const contextResponse = await fetch(`${BACKEND_URL}/get-context?query=${encodeURIComponent(messageText)}`);
                    if (!contextResponse.ok) {
                        throw new Error(`Backend context error: ${contextResponse.statusText}`);
                    }
                    const retrievedChunks = await contextResponse.json();
                    
                    if (retrievedChunks.length > 0) {
                         fileContextString = retrievedChunks
                            .map(chunk => `[File: ${chunk.fileName}, Chunk: ${chunk.chunkIndex}]\n${chunk.text}`)
                            .join('\n\n---\n\n');
                        console.log("Retrieved context:", fileContextString);
                    } else {
                        console.log("No relevant context found in local files.");
                    }
                } catch (err) {
                    console.error("Could not fetch RAG context:", err);
                    addMessage("Warning: Could not connect to local RAG backend. Answering without file context.", 'assistant');
                }
                
                // 2. Call Gemini with the retrieved context
                showLoading("Calling Gemini...");
                const aiResponse = await callGeminiAPI(messageText, formattedHistory, useSearch, fileContextString);
                
                addMessage(aiResponse, 'assistant');
                saveMessage(aiResponse, 'assistant');

            } catch (error) {
                console.error("Error during message sending:", error);
                addMessage(`Sorry, I encountered an error: ${error.message}`, 'assistant');
            } finally {
                hideLoading();
            }
        }

        /**
         * Adds a message to the chat.
         * Sanitizes text and formats newlines.
         */
        function addMessage(text, sender, animate = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender} ${animate ? 'animated' : ''}`;
            
            const time = new Date().toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit', 
                hour12: true 
            });

            // Create a temporary div to safely encode text
            const tempDiv = document.createElement('div');
            tempDiv.textContent = text;
            
            // Basic markdown for newlines, bold, and code blocks
            let sanitizedText = tempDiv.innerHTML
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                .replace(/```(\w*?)\s*<br>([\s\S]*?)<br>```/g, '<pre><code>$2</code></pre>') // Code blocks
                .replace(/`(.*?)`/g, '<code>$1</code>'); // Inline code

            messageDiv.innerHTML = `
                <div class="message-avatar">${sender === 'user' ? 'U' : 'AI'}</div>
                <div class="message-body">
                    <div class="message-content">${sanitizedText}</div>
                    <div class="timestamp">${time}</div>
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function removeWelcomeMessage() {
            if (welcomeMessage) {
                welcomeMessage.style.display = 'none';
            }
        }

        // --- Gemini API Call ---
        
        /**
         * Converts stored history to Gemini's `contents` format.
         */
        function historyToGeminiFormat(history) {
            const contents = [];
            let lastRole = '';
            
            for (const msg of history) {
                const role = (msg.sender === 'user') ? 'user' : 'model';
                if (role === lastRole) {
                    // Combine consecutive messages from the same role
                    contents[contents.length - 1].parts[0].text += `\n\n${msg.text}`;
                } else {
                    contents.push({
                        role: role,
                        parts: [{ text: msg.text }]
                    });
                }
                lastRole = role;
            }
            return contents;
        }

        /**
         * Calls the Gemini API with exponential backoff.
         */
        async function callGeminiAPI(prompt, history = [], useSearch = false, fileContextString = "", retries = 3, delay = 1000) {
            if (GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_GOES_HERE") {
                return "Please set your Gemini API key in the chat.html file.";
            }
            
            let contextMessages = [];
            if (fileContextString) {
                contextMessages.push({
                    role: 'user',
                    // This is the new, stricter prompt
                    parts: [{ text: `You MUST strictly answer based ONLY on the following retrieved chunks. Do not use any other information. If the answer is not in the chunks, say "I cannot answer this based on the provided files." Here is the context:\n\n${fileContextString}` }]
                 }, {
                role: 'model',
                // Updated model acknowledgment
                parts: [{ text: "Okay, I will strictly answer based only on the provided context and will not use any other information." }]
            });
        }

            const payload = {
                contents: [
                    ...contextMessages,
                    ...history,
                    { role: 'user', parts: [{ text: prompt }] }
                ],
                tools: useSearch ? [{ "google_search": {} }] : []
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API Error ${response.status}: ${errorBody}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0) {
                        const content = result.candidates[0].content.parts[0].text;
                        return content;
                    } else {
                        return "Sorry, I received an empty response from the AI.";
                    }
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i === retries - 1) {
                        throw error;
                    }
                    await new Promise(res => setTimeout(res, delay * (i + 1)));
                }
            }
        }

        // --- History Management ---
        function saveMessage(text, sender) {
            const history = getHistory();
            history.push({ text, sender });
            localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(history));
        }

        function loadHistory() {
            const history = getHistory();
            if (history.length > 0) {
                removeWelcomeMessage();
                history.forEach(msg => addMessage(msg.text, msg.sender, false));
            }
        }

        function getHistory() {
            return JSON.parse(localStorage.getItem(CHAT_HISTORY_KEY) || '[]');
        }

        function clearChat() {
            chatMessages.innerHTML = ''; // Clear DOM
            localStorage.removeItem(CHAT_HISTORY_KEY); // Clear storage
            if (welcomeMessage) {
                welcomeMessage.style.display = 'block';
            }
            chatMessages.appendChild(welcomeMessage);
        }

        // --- File Management ---
        async function handleFileUpload(e) {
            const files = e.target.files;
            if (!files) return;

            for (const file of files) {
                if (file.type.startsWith('text/')) {
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    showLoading(`Uploading ${file.name}...`);
                    try {
                        const response = await fetch(`${BACKEND_URL}/upload`, {
                            method: 'POST',
                            body: formData
                        });
                        
                        const result = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(result.error || 'Unknown upload error');
                        }
                        
                        addFileToDOM(file.name);
                        saveFile(file.name); 
                        addMessage(result.message, 'assistant');

                    } catch (err) {
                         console.error("File upload error:", err);
                         addMessage(`Error uploading ${file.name}: ${err.message}. Is the backend running?`, 'assistant');
                    } finally {
                        hideLoading();
                    }
                    
                } else {
                    addMessage(`Sorry, I can only read text files for now. '${file.name}' was not added.`, 'assistant');
                }
            }
            e.target.value = null; // Clear input to allow re-upload
        }

        function addFileToDOM(fileName) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.dataset.filename = fileName;
            fileItem.title = fileName; // Show full name on hover

            fileItem.innerHTML = `
                <div class="file-info">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    <span>${fileName}</span>
                </div>
                <button class="delete-file-btn" title="Delete file from vector database">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            `;
            fileList.appendChild(fileItem);
        }

        async function handleFileDelete(e) {
            const deleteButton = e.target.closest('.delete-file-btn');
            if (deleteButton) {
                const fileItem = deleteButton.closest('.file-item');
                const fileName = fileItem.dataset.filename;
                
                showLoading(`Deleting ${fileName}...`);
                try {
                    const response = await fetch(`${BACKEND_URL}/delete`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ fileName: fileName })
                    });
                    
                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.error || 'Delete error');
                    }
                    
                    fileItem.remove();
                    removeFile(fileName);
                    addMessage(result.message, 'assistant');

                } catch (err) {
                    console.error("File delete error:", err);
                    addMessage(`Error deleting ${fileName}: ${err.message}.`, 'assistant');
                } finally {
                    hideLoading();
                }
            }
        }

        function getFiles() {
            // Stores only names
            return JSON.parse(localStorage.getItem(FILE_LIST_KEY) || '[]');
        }

        function saveFile(fileName) {
            const files = getFiles();
            if (!files.includes(fileName)) {
                files.push(fileName);
                localStorage.setItem(FILE_LIST_KEY, JSON.stringify(files));
            }
        }
        
        function loadFiles() {
            const files = getFiles();
            files.forEach(file => addFileToDOM(file));
        }
        
        function removeFile(fileName) {
            let files = getFiles();
            files = files.filter(f => f !== fileName);
            localStorage.setItem(FILE_LIST_KEY, JSON.stringify(files));
        }

        // --- Utility ---
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    </script>
</body>
</html>